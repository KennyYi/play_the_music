(function(){"use strict";function J(m){return m&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m}var I={exports:{}},L=I.exports,V;function Q(){return V||(V=1,(function(m,w){(function(v,p){m.exports=p()})(L,(function(){function v(e,t,a){for(var r,n=0,o=t.length;n<o;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))}var p=Object.freeze({__proto__:null,blackman:function(e){for(var t=new Float32Array(e),a=2*Math.PI/(e-1),r=2*a,n=0;n<e/2;n++)t[n]=.42-.5*Math.cos(n*a)+.08*Math.cos(n*r);for(n=Math.ceil(e/2);n>0;n--)t[e-n]=t[n-1];return t},hamming:function(e){for(var t=new Float32Array(e),a=0;a<e;a++)t[a]=.54-.46*Math.cos(2*Math.PI*(a/e-1));return t},hanning:function(e){for(var t=new Float32Array(e),a=0;a<e;a++)t[a]=.5-.5*Math.cos(2*Math.PI*a/(e-1));return t},sine:function(e){for(var t=Math.PI/(e-1),a=new Float32Array(e),r=0;r<e;r++)a[r]=Math.sin(t*r);return a}}),h={};function M(e){for(;e%2==0&&e>1;)e/=2;return e===1}function k(e,t){if(t!=="rect"){if(t!==""&&t||(t="hanning"),h[t]||(h[t]={}),!h[t][e.length])try{h[t][e.length]=p[t](e.length)}catch{throw new Error("Invalid windowing function")}e=(function(a,r){for(var n=[],o=0;o<Math.min(a.length,r.length);o++)n[o]=a[o]*r[o];return n})(e,h[t][e.length])}return e}function _(e,t,a){for(var r=new Float32Array(e),n=0;n<r.length;n++)r[n]=n*t/a,r[n]=13*Math.atan(r[n]/1315.8)+3.5*Math.atan(Math.pow(r[n]/7518,2));return r}function R(e){return Float32Array.from(e)}function j(e){return 1125*Math.log(1+e/700)}function A(e,t,a){for(var r,n=new Float32Array(e+2),o=new Float32Array(e+2),f=t/2,l=j(0),u=(j(f)-l)/(e+1),i=new Array(e+2),c=0;c<n.length;c++)n[c]=c*u,o[c]=(r=n[c],700*(Math.exp(r/1125)-1)),i[c]=Math.floor((a+1)*o[c]/t);for(var y=new Array(e),s=0;s<y.length;s++){for(y[s]=new Array(a/2+1).fill(0),c=i[s];c<i[s+1];c++)y[s][c]=(c-i[s])/(i[s+1]-i[s]);for(c=i[s+1];c<i[s+2];c++)y[s][c]=(i[s+2]-c)/(i[s+2]-i[s+1])}return y}function U(e,t,a,r,n,o,f){r===void 0&&(r=5),n===void 0&&(n=2),o===void 0&&(o=!0),f===void 0&&(f=440);var l=Math.floor(a/2)+1,u=new Array(a).fill(0).map((function(g,d){return e*(function(b,B){return Math.log2(16*b/B)})(t*d/a,f)}));u[0]=u[1]-1.5*e;var i,c,y,s=u.slice(1).map((function(g,d){return Math.max(g-u[d])}),1).concat([1]),C=Math.round(e/2),F=new Array(e).fill(0).map((function(g,d){return u.map((function(b){return(10*e+C+b-d)%e-C}))})),E=F.map((function(g,d){return g.map((function(b,B){return Math.exp(-.5*Math.pow(2*F[d][B]/s[B],2))}))}));if(c=(i=E)[0].map((function(){return 0})),y=i.reduce((function(g,d){return d.forEach((function(b,B){g[B]+=Math.pow(b,2)})),g}),c).map(Math.sqrt),E=i.map((function(g,d){return g.map((function(b,B){return b/(y[B]||1)}))})),n){var X=u.map((function(g){return Math.exp(-.5*Math.pow((g/e-r)/n,2))}));E=E.map((function(g){return g.map((function(d,b){return d*X[b]}))}))}return o&&(E=v(v([],E.slice(3),!0),E.slice(0,3))),E.map((function(g){return g.slice(0,l)}))}function S(e,t){for(var a=0,r=0,n=0;n<t.length;n++)a+=Math.pow(n,e)*Math.abs(t[n]),r+=t[n];return a/r}function D(e){var t=e.ampSpectrum,a=e.barkScale,r=e.numberOfBarkBands,n=r===void 0?24:r;if(typeof t!="object"||typeof a!="object")throw new TypeError;var o=n,f=new Float32Array(o),l=0,u=t,i=new Int32Array(o+1);i[0]=0;for(var c=a[u.length-1]/o,y=1,s=0;s<u.length;s++)for(;a[s]>c;)i[y++]=s,c=y*a[u.length-1]/o;for(i[o]=u.length-1,s=0;s<o;s++){for(var C=0,F=i[s];F<i[s+1];F++)C+=u[F];f[s]=Math.pow(C,.23)}for(s=0;s<f.length;s++)l+=f[s];return{specific:f,total:l}}function H(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;for(var a=new Float32Array(t.length),r=0;r<a.length;r++)a[r]=Math.pow(t[r],2);return a}function K(e){var t=e.ampSpectrum,a=e.melFilterBank,r=e.bufferSize;if(typeof t!="object")throw new TypeError("Valid ampSpectrum is required to generate melBands");if(typeof a!="object")throw new TypeError("Valid melFilterBank is required to generate melBands");for(var n=H({ampSpectrum:t}),o=a.length,f=Array(o),l=new Float32Array(o),u=0;u<l.length;u++){f[u]=new Float32Array(r/2),l[u]=0;for(var i=0;i<r/2;i++)f[u][i]=a[u][i]*n[i],l[u]+=f[u][i];l[u]=Math.log(l[u]+1)}return Array.prototype.slice.call(l)}function rt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var T=null,at=rt((function(e,t){var a=e.length;return t=t||2,T&&T[a]||(function(r){(T=T||{})[r]=new Array(r*r);for(var n=Math.PI/r,o=0;o<r;o++)for(var f=0;f<r;f++)T[r][f+o*r]=Math.cos(n*(f+.5)*o)})(a),e.map((function(){return 0})).map((function(r,n){return t*e.reduce((function(o,f,l,u){return o+f*T[a][l+n*a]}),0)}))})),$=Object.freeze({__proto__:null,amplitudeSpectrum:function(e){return e.ampSpectrum},buffer:function(e){return e.signal},chroma:function(e){var t=e.ampSpectrum,a=e.chromaFilterBank;if(typeof t!="object")throw new TypeError("Valid ampSpectrum is required to generate chroma");if(typeof a!="object")throw new TypeError("Valid chromaFilterBank is required to generate chroma");var r=a.map((function(o,f){return t.reduce((function(l,u,i){return l+u*o[i]}),0)})),n=Math.max.apply(Math,r);return n?r.map((function(o){return o/n})):r},complexSpectrum:function(e){return e.complexSpectrum},energy:function(e){var t=e.signal;if(typeof t!="object")throw new TypeError;for(var a=0,r=0;r<t.length;r++)a+=Math.pow(Math.abs(t[r]),2);return a},loudness:D,melBands:K,mfcc:function(e){var t=e.ampSpectrum,a=e.melFilterBank,r=e.numberOfMFCCCoefficients,n=e.bufferSize,o=Math.min(40,Math.max(1,r||13));if(a.length<o)throw new Error("Insufficient filter bank for requested number of coefficients");var f=K({ampSpectrum:t,melFilterBank:a,bufferSize:n});return at(f).slice(0,o)},perceptualSharpness:function(e){for(var t=D({ampSpectrum:e.ampSpectrum,barkScale:e.barkScale}),a=t.specific,r=0,n=0;n<a.length;n++)r+=n<15?(n+1)*a[n+1]:.066*Math.exp(.171*(n+1));return r*=.11/t.total},perceptualSpread:function(e){for(var t=D({ampSpectrum:e.ampSpectrum,barkScale:e.barkScale}),a=0,r=0;r<t.specific.length;r++)t.specific[r]>a&&(a=t.specific[r]);return Math.pow((t.total-a)/t.total,2)},powerSpectrum:H,rms:function(e){var t=e.signal;if(typeof t!="object")throw new TypeError;for(var a=0,r=0;r<t.length;r++)a+=Math.pow(t[r],2);return a/=t.length,a=Math.sqrt(a)},spectralCentroid:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;return S(1,t)},spectralCrest:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;var a=0,r=-1/0;return t.forEach((function(n){a+=Math.pow(n,2),r=n>r?n:r})),a/=t.length,a=Math.sqrt(a),r/a},spectralFlatness:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;for(var a=0,r=0,n=0;n<t.length;n++)a+=Math.log(t[n]),r+=t[n];return Math.exp(a/t.length)*t.length/r},spectralFlux:function(e){var t=e.signal,a=e.previousSignal,r=e.bufferSize;if(typeof t!="object"||typeof a!="object")throw new TypeError;for(var n=0,o=-r/2;o<t.length/2-1;o++)x=Math.abs(t[o])-Math.abs(a[o]),n+=(x+Math.abs(x))/2;return n},spectralKurtosis:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;var a=t,r=S(1,a),n=S(2,a),o=S(3,a),f=S(4,a);return(-3*Math.pow(r,4)+6*r*n-4*r*o+f)/Math.pow(Math.sqrt(n-Math.pow(r,2)),4)},spectralRolloff:function(e){var t=e.ampSpectrum,a=e.sampleRate;if(typeof t!="object")throw new TypeError;for(var r=t,n=a/(2*(r.length-1)),o=0,f=0;f<r.length;f++)o+=r[f];for(var l=.99*o,u=r.length-1;o>l&&u>=0;)o-=r[u],--u;return(u+1)*n},spectralSkewness:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;var a=S(1,t),r=S(2,t),n=S(3,t);return(2*Math.pow(a,3)-3*a*r+n)/Math.pow(Math.sqrt(r-Math.pow(a,2)),3)},spectralSlope:function(e){var t=e.ampSpectrum,a=e.sampleRate,r=e.bufferSize;if(typeof t!="object")throw new TypeError;for(var n=0,o=0,f=new Float32Array(t.length),l=0,u=0,i=0;i<t.length;i++){n+=t[i];var c=i*a/r;f[i]=c,l+=c*c,o+=c,u+=c*t[i]}return(t.length*u-o*n)/(n*(l-Math.pow(o,2)))},spectralSpread:function(e){var t=e.ampSpectrum;if(typeof t!="object")throw new TypeError;return Math.sqrt(S(2,t)-Math.pow(S(1,t),2))},zcr:function(e){var t=e.signal;if(typeof t!="object")throw new TypeError;for(var a=0,r=1;r<t.length;r++)(t[r-1]>=0&&t[r]<0||t[r-1]<0&&t[r]>=0)&&a++;return a}});function nt(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}var P={},q={},z={bitReverseArray:function(e){if(P[e]===void 0){for(var t=(e-1).toString(2).length,a="0".repeat(t),r={},n=0;n<e;n++){var o=n.toString(2);o=a.substr(o.length)+o,o=[].concat(nt(o)).reverse().join(""),r[n]=parseInt(o,2)}P[e]=r}return P[e]},multiply:function(e,t){return{real:e.real*t.real-e.imag*t.imag,imag:e.real*t.imag+e.imag*t.real}},add:function(e,t){return{real:e.real+t.real,imag:e.imag+t.imag}},subtract:function(e,t){return{real:e.real-t.real,imag:e.imag-t.imag}},euler:function(e,t){var a=-2*Math.PI*e/t;return{real:Math.cos(a),imag:Math.sin(a)}},conj:function(e){return e.imag*=-1,e},constructComplexArray:function(e){var t={};t.real=e.real===void 0?e.slice():e.real.slice();var a=t.real.length;return q[a]===void 0&&(q[a]=Array.apply(null,Array(a)).map(Number.prototype.valueOf,0)),t.imag=q[a].slice(),t}},ot=function(e){var t={};e.real===void 0||e.imag===void 0?t=z.constructComplexArray(e):(t.real=e.real.slice(),t.imag=e.imag.slice());var a=t.real.length,r=Math.log2(a);if(Math.round(r)!=r)throw new Error("Input size must be a power of 2.");if(t.real.length!=t.imag.length)throw new Error("Real and imaginary components must have the same length.");for(var n=z.bitReverseArray(a),o={real:[],imag:[]},f=0;f<a;f++)o.real[n[f]]=t.real[f],o.imag[n[f]]=t.imag[f];for(var l=0;l<a;l++)t.real[l]=o.real[l],t.imag[l]=o.imag[l];for(var u=1;u<=r;u++)for(var i=Math.pow(2,u),c=0;c<i/2;c++)for(var y=z.euler(c,i),s=0;s<a/i;s++){var C=i*s+c,F=i*s+c+i/2,E={real:t.real[C],imag:t.imag[C]},X={real:t.real[F],imag:t.imag[F]},g=z.multiply(y,X),d=z.subtract(E,g);t.real[F]=d.real,t.imag[F]=d.imag;var b=z.add(g,E);t.real[C]=b.real,t.imag[C]=b.imag}return t},it=ot,ut=(function(){function e(t,a){var r=this;if(this._m=a,!t.audioContext)throw this._m.errors.noAC;if(t.bufferSize&&!M(t.bufferSize))throw this._m._errors.notPow2;if(!t.source)throw this._m._errors.noSource;this._m.audioContext=t.audioContext,this._m.bufferSize=t.bufferSize||this._m.bufferSize||256,this._m.hopSize=t.hopSize||this._m.hopSize||this._m.bufferSize,this._m.sampleRate=t.sampleRate||this._m.audioContext.sampleRate||44100,this._m.callback=t.callback,this._m.windowingFunction=t.windowingFunction||"hanning",this._m.featureExtractors=$,this._m.EXTRACTION_STARTED=t.startImmediately||!1,this._m.channel=typeof t.channel=="number"?t.channel:0,this._m.inputs=t.inputs||1,this._m.outputs=t.outputs||1,this._m.numberOfMFCCCoefficients=t.numberOfMFCCCoefficients||this._m.numberOfMFCCCoefficients||13,this._m.numberOfBarkBands=t.numberOfBarkBands||this._m.numberOfBarkBands||24,this._m.spn=this._m.audioContext.createScriptProcessor(this._m.bufferSize,this._m.inputs,this._m.outputs),this._m.spn.connect(this._m.audioContext.destination),this._m._featuresToExtract=t.featureExtractors||[],this._m.barkScale=_(this._m.bufferSize,this._m.sampleRate,this._m.bufferSize),this._m.melFilterBank=A(Math.max(this._m.melBands,this._m.numberOfMFCCCoefficients),this._m.sampleRate,this._m.bufferSize),this._m.inputData=null,this._m.previousInputData=null,this._m.frame=null,this._m.previousFrame=null,this.setSource(t.source),this._m.spn.onaudioprocess=function(n){var o;r._m.inputData!==null&&(r._m.previousInputData=r._m.inputData),r._m.inputData=n.inputBuffer.getChannelData(r._m.channel),r._m.previousInputData?((o=new Float32Array(r._m.previousInputData.length+r._m.inputData.length-r._m.hopSize)).set(r._m.previousInputData.slice(r._m.hopSize)),o.set(r._m.inputData,r._m.previousInputData.length-r._m.hopSize)):o=r._m.inputData;var f=(function(l,u,i){if(l.length<u)throw new Error("Buffer is too short for frame length");if(i<1)throw new Error("Hop length cannot be less that 1");if(u<1)throw new Error("Frame length cannot be less that 1");var c=1+Math.floor((l.length-u)/i);return new Array(c).fill(0).map((function(y,s){return l.slice(s*i,s*i+u)}))})(o,r._m.bufferSize,r._m.hopSize);f.forEach((function(l){r._m.frame=l;var u=r._m.extract(r._m._featuresToExtract,r._m.frame,r._m.previousFrame);typeof r._m.callback=="function"&&r._m.EXTRACTION_STARTED&&r._m.callback(u),r._m.previousFrame=r._m.frame}))}}return e.prototype.start=function(t){this._m._featuresToExtract=t||this._m._featuresToExtract,this._m.EXTRACTION_STARTED=!0},e.prototype.stop=function(){this._m.EXTRACTION_STARTED=!1},e.prototype.setSource=function(t){this._m.source&&this._m.source.disconnect(this._m.spn),this._m.source=t,this._m.source.connect(this._m.spn)},e.prototype.setChannel=function(t){t<=this._m.inputs?this._m.channel=t:console.error("Channel ".concat(t," does not exist. Make sure you've provided a value for 'inputs' that is greater than ").concat(t," when instantiating the MeydaAnalyzer"))},e.prototype.get=function(t){return this._m.inputData?this._m.extract(t||this._m._featuresToExtract,this._m.inputData,this._m.previousInputData):null},e})(),N={audioContext:null,spn:null,bufferSize:512,sampleRate:44100,melBands:26,chromaBands:12,callback:null,windowingFunction:"hanning",featureExtractors:$,EXTRACTION_STARTED:!1,numberOfMFCCCoefficients:13,numberOfBarkBands:24,_featuresToExtract:[],windowing:k,_errors:{notPow2:new Error("Meyda: Buffer size must be a power of 2, e.g. 64 or 512"),featureUndef:new Error("Meyda: No features defined."),invalidFeatureFmt:new Error("Meyda: Invalid feature format"),invalidInput:new Error("Meyda: Invalid input."),noAC:new Error("Meyda: No AudioContext specified."),noSource:new Error("Meyda: No source node specified.")},createMeydaAnalyzer:function(e){return new ut(e,Object.assign({},N))},listAvailableFeatureExtractors:function(){return Object.keys(this.featureExtractors)},extract:function(e,t,a){var r=this;if(!t)throw this._errors.invalidInput;if(typeof t!="object")throw this._errors.invalidInput;if(!e)throw this._errors.featureUndef;if(!M(t.length))throw this._errors.notPow2;this.barkScale!==void 0&&this.barkScale.length==this.bufferSize||(this.barkScale=_(this.bufferSize,this.sampleRate,this.bufferSize)),this.melFilterBank!==void 0&&this.barkScale.length==this.bufferSize&&this.melFilterBank.length==this.melBands||(this.melFilterBank=A(Math.max(this.melBands,this.numberOfMFCCCoefficients),this.sampleRate,this.bufferSize)),this.chromaFilterBank!==void 0&&this.chromaFilterBank.length==this.chromaBands||(this.chromaFilterBank=U(this.chromaBands,this.sampleRate,this.bufferSize)),"buffer"in t&&t.buffer===void 0?this.signal=R(t):this.signal=t;var n=G(t,this.windowingFunction,this.bufferSize);if(this.signal=n.windowedSignal,this.complexSpectrum=n.complexSpectrum,this.ampSpectrum=n.ampSpectrum,a){var o=G(a,this.windowingFunction,this.bufferSize);this.previousSignal=o.windowedSignal,this.previousComplexSpectrum=o.complexSpectrum,this.previousAmpSpectrum=o.ampSpectrum}var f=function(l){return r.featureExtractors[l]({ampSpectrum:r.ampSpectrum,chromaFilterBank:r.chromaFilterBank,complexSpectrum:r.complexSpectrum,signal:r.signal,bufferSize:r.bufferSize,sampleRate:r.sampleRate,barkScale:r.barkScale,melFilterBank:r.melFilterBank,previousSignal:r.previousSignal,previousAmpSpectrum:r.previousAmpSpectrum,previousComplexSpectrum:r.previousComplexSpectrum,numberOfMFCCCoefficients:r.numberOfMFCCCoefficients,numberOfBarkBands:r.numberOfBarkBands})};if(typeof e=="object")return e.reduce((function(l,u){var i;return Object.assign({},l,((i={})[u]=f(u),i))}),{});if(typeof e=="string")return f(e);throw this._errors.invalidFeatureFmt}},G=function(e,t,a){var r={};e.buffer===void 0?r.signal=R(e):r.signal=e,r.windowedSignal=k(r.signal,t),r.complexSpectrum=it(r.windowedSignal),r.ampSpectrum=new Float32Array(a/2);for(var n=0;n<a/2;n++)r.ampSpectrum[n]=Math.sqrt(Math.pow(r.complexSpectrum.real[n],2)+Math.pow(r.complexSpectrum.imag[n],2));return r};return typeof window<"u"&&(window.Meyda=N),N}))})(I)),I.exports}var W=Q(),O=J(W);function Y(m,w){const p=[];let h=!1;for(let A=0;A<m.length;A++){const S=Math.abs(m[A])>.3;S&&!h&&p.push(A),h=S}if(p.length<2)return 0;let M=0;for(let A=1;A<p.length;A++)M+=p[A]-p[A-1];const k=M/(p.length-1),_=w*60/k;return _<40||_>400?0:_}self.onmessage=m=>{const w=m.data;if(w.type!=="analyze")return;const{samples:v,sampleRate:p}=w,h=2048;O.sampleRate=p,O.bufferSize=h;const M=et(v,h),k=Z(v),_=Y(v,p),R=tt(v,1e3),j={type:"analysisResult",rms:k,waveform:R,tempo:_,spectral:M};self.postMessage(j)};function Z(m){let w=0;for(let v=0;v<m.length;v++){const p=m[v];w+=p*p}return Math.sqrt(w/m.length)}function tt(m,w){const v=Math.floor(m.length/w),p=new Float32Array(w);for(let h=0;h<w;h++)p[h]=m[h*v]||0;return p}function et(m,w){let v=0,p=0,h=0;for(let M=0;M+w<=m.length;M+=w){const k=m.subarray(M,M+w),_=O.extract(["spectralCentroid","spectralRolloff"],k);_&&(typeof _.spectralCentroid=="number"&&(v+=_.spectralCentroid),typeof _.spectralRolloff=="number"&&(p+=_.spectralRolloff),h++)}return{centroid:h?v/h:0,rolloff:h?p/h:0}}})();
